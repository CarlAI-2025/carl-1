name: Build and Test ETL Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Run Maven tests
      run: mvn clean test --batch-mode

    - name: Build with Maven
      run: mvn clean package -DskipTests --batch-mode

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: etl-pipeline-jar
        path: target/carl-1-1.0-SNAPSHOT.jar
        retention-days: 5

    - name: Generate test report
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: JUnit Report
        path: target/surefire-reports/*.xml
        reporter: 'java-junit'

  sonarqube:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Run SonarQube analysis
      run: |
        mvn clean verify sonar:sonar \
          -Dsonar.projectKey=etl-agent-pipeline \
          -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      if: ${{ secrets.SONAR_HOST_URL != '' }}

  deploy-dev:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'

    steps:
    - uses: actions/checkout@v3

    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: etl-pipeline-jar

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Deploy to Cloud Functions (Dev)
      run: |
        gcloud functions deploy etl-pipeline-dev \
          --runtime java17 \
          --trigger-topic etl-trigger-dev \
          --entry-point com.etl.agent.ETLPipelineMain \
          --memory 512MB \
          --timeout 300 \
          --source . \
          --set-env-vars PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},DATASET_ID=etl_dev

  deploy-prod:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://console.cloud.google.com/functions

    steps:
    - uses: actions/checkout@v3

    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: etl-pipeline-jar

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Deploy to Cloud Functions (Prod)
      run: |
        gcloud functions deploy etl-pipeline-prod \
          --runtime java17 \
          --trigger-topic etl-trigger \
          --entry-point com.etl.agent.ETLPipelineMain \
          --memory 1024MB \
          --timeout 600 \
          --source . \
          --set-env-vars PROJECT_ID=${{ secrets.GCP_PROJECT_ID_PROD }},DATASET_ID=etl_production

    - name: Create deployment notification
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… ETL Pipeline deployed to production'
          })

